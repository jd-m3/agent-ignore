#!/usr/bin/env node
// Adds AI agent folders to .gitignore

const fs = require("fs");
const path = require("path");
const { execSync } = require("child_process");

const MARKER = "# AI Agents - Generated by agent-ignore";
const GITIGNORE = ".gitignore";
const FOLDERS_FILE = path.join(__dirname, "agent-folders.txt");

// Find git root or use current directory
function getGitRoot() {
  try {
    const root = execSync("git rev-parse --show-toplevel", {
      encoding: "utf-8",
      stdio: ["pipe", "pipe", "pipe"],
    }).trim();
    return root;
  } catch {
    return process.cwd();
  }
}

function main() {
  const root = getGitRoot();
  const gitignorePath = path.join(root, GITIGNORE);

  // Check if folders file exists
  if (!fs.existsSync(FOLDERS_FILE)) {
    console.error(`Error: ${FOLDERS_FILE} not found`);
    process.exit(1);
  }

  // Check if section already exists
  if (fs.existsSync(gitignorePath)) {
    const content = fs.readFileSync(gitignorePath, "utf-8");
    if (content.includes(MARKER)) {
      console.log("AI agents section already exists in .gitignore");
      process.exit(0);
    }
  }

  // Read folders to ignore
  const folders = fs.readFileSync(FOLDERS_FILE, "utf-8");

  // Append AI agents section
  const section = `\n${MARKER}\n${folders}`;
  fs.appendFileSync(gitignorePath, section);

  console.log(`Added AI agents to ${gitignorePath}`);
}

main();
